import { Component } from '@angular/core';
import { ICellRendererAngularComp } from 'ag-grid-angular';
import { MatDialog } from '@angular/material/dialog';
import { EditDescriptionDialogComponent } from '../edit-description-dialog/edit-description-dialog.component'

@Component({
  selector: 'app-description-button-cell',
  template: `
    <div class="flex justify-between items-center w-full">
      <span class="truncate text-sm max-w-[85%] text-gray-700 italic">
        {{ preview || 'Click to add description' }}
      </span>
      <button class="text-xs px-2 py-0.5 bg-gray-200 rounded hover:bg-gray-300"
              (click)="openDialog()" title="Edit Description">
        …
      </button>
    </div>
  `
})
export class DescriptionButtonCellComponent implements ICellRendererAngularComp {
  params: any;
  preview: string = '';

  constructor(private dialog: MatDialog) {}

  agInit(params: any): void {
    this.params = params;

    const html = params.value || '';
    const div = document.createElement('div');
    div.innerHTML = html;
    const text = div.textContent || div.innerText || '';
    this.preview = text.length > 80 ? text.slice(0, 80) + '…' : text;
  }

  refresh(): boolean {
    return false;
  }

  openDialog() {
    const selected = this.params.data['selected']?.toLowerCase();
    if (selected !== 'yes') {
      alert('Please mark this row as selected (select = yes) before editing.');
      return;
    }

    this.dialog.open(EditDescriptionDialogComponent, {
      width: '600px',
      data: {
        currentValue: this.params.value || '',
        jobId: this.params.data['job_id'],
        node: this.params.node
      }
    });
  }
}
